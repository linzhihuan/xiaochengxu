<view class="container safe-bottom">
  
  <!-- 1. 顶部导航 -->
  <view class="nav-bar" style="padding-top:{{statusBarHeight}}px">
    <view class="back-icon" bindtap="goBack">✕</view>
    <text class="nav-title">Customize</text>
    <view class="nav-spacer"></view>
  </view>

  <scroll-view scroll-y class="main-scroll" enable-flex>
    
    <!-- 2. 预览舞台 (动态合成) -->
    <view class="preview-stage">
      <view class="canvas-box shadow-lg">
        <!-- 模拟遮罩：相框/形状 (层级高) -->
        <!-- 注意：实际开发需用透明PNG，中间镂空 -->
        <image class="mask-layer" src="{{activeTemplate.mask}}" mode="aspectFit"></image>
        
        <!-- 用户照片 (层级低) -->
        <image class="photo-layer" src="{{selectedPhoto}}" mode="aspectFill"></image>
        
        <!-- 空状态引导 -->
        <view class="empty-guide" wx:if="{{!selectedPhoto}}">
          <text class="plus">+</text>
          <text class="tip">Select Photo</text>
        </view>
      </view>
      <text class="preview-caption">{{activeTemplate.name}} - ¥{{totalPrice}}</text>
    </view>

    <!-- 3. 配置面板 -->
    <view class="config-panel">
      
      <!-- Section A: 选照片 -->
      <view class="config-section">
        <view class="section-title">
          <text>01. Photo</text>
          <text class="subtitle">From your favorites</text>
        </view>
        <scroll-view scroll-x class="picker-scroll" enable-flex>
          <!-- 空状态/去登录 -->
          <view class="picker-item empty" wx:if="{{myFavorites.length === 0}}" bindtap="handleNoFav">
            <text>{{isLogin ? 'Go Gallery' : 'Login'}}</text>
          </view>
          
          <view class="picker-item {{selectedPhoto == item.img ? 'active' : ''}}" 
                wx:for="{{myFavorites}}" wx:key="id"
                bindtap="handleSelectPhoto" data-url="{{item.img}}">
            <image src="{{item.img}}" mode="aspectFill"></image>
            <view class="active-border"></view>
          </view>
        </scroll-view>
      </view>

      <!-- Section B: 选模板 (Visual Style) -->
      <view class="config-section">
        <view class="section-title">
          <text>02. Style</text>
          <text class="subtitle">{{productInfo.name}} variants</text>
        </view>
        <scroll-view scroll-x class="picker-scroll" enable-flex>
          <view class="style-card {{index === activeTemplateIndex ? 'active' : ''}}"
                wx:for="{{productInfo.templates}}" wx:key="id"
                bindtap="handleSelectTemplate" data-index="{{index}}">
            <image src="{{item.img}}" mode="aspectFit" class="style-thumb"></image>
            <text class="style-name">{{item.name}}</text>
            <view class="active-dot" wx:if="{{index === activeTemplateIndex}}"></view>
          </view>
        </scroll-view>
      </view>

      <!-- Section C: 动态渲染规格选项 (Size, Material, etc.) -->
      <block wx:for="{{productInfo.options}}" wx:key="id" wx:for-item="option">
        <view class="config-section">
          <view class="section-title">
            <text>0{{index + 3}}. {{option.name}}</text>
          </view>
          <view class="chips-container">
            <view class="chip {{selectedOptions[option.id] === choice.id ? 'active' : ''}}"
                  wx:for="{{option.choices}}" wx:key="id" wx:for-item="choice"
                  bindtap="handleSelectOption" 
                  data-opt-id="{{option.id}}" 
                  data-choice-id="{{choice.id}}">
              <text>{{choice.name}}</text>
              <!-- 显示加价信息 -->
              <text class="price-mod" wx:if="{{choice.priceMod > 0}}">+¥{{choice.priceMod}}</text>
            </view>
          </view>
        </view>
      </block>
      
      <!-- 底部垫高 -->
      <view style="height: 180rpx;"></view>
    </view>
  </scroll-view>

  <!-- 4. 底部浮动栏 -->
  <view class="footer-bar">
    <view class="price-block">
      <text class="label">Total Amount</text>
      <text class="val">¥{{totalPrice}}</text>
    </view>
    <button class="add-btn" bindtap="handleCheckout">Add to Cart</button>
  </view>
</view>


